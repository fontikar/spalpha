---
title: "ALA Data Retrieval"
author: "Ashley Browse"
date: "2023-07-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Accessing data from ALA

This document lays out the workflow of getting data for Mygalomorph spiders from the ALA database 

## Load dependencies

```{r loadpackages}
install.packages("pacman")
pacman::p_load(galah, arrow, usethis, tidyverse, janitor)
```

## Account Registration and {galah} Configuration 

Before downloading data from ALA, we need an email registered with ALA. We can then download ALA occurrence data, filtering to within Australia and using ALA's data cleaning filters.

```{r}
# Add ALA registered email to access data (register at ala.org.au)
edit_r_environ()
# Paste in R environment ALA_EMAIL="your.email@email.com"

# Retrieve email (secretly)
Sys.getenv("ALA_EMAIL")

# Configure galah
galah_config(email = Sys.getenv("ALA_EMAIL"), 
             atlas = "Australia")
```

## Download data

### Assertions

<!-- Decide what assertions to filter data by --> 
<!-- Ashley can you investigate how do we get these from galah -->
<!-- We want a .csv of these and we can explore as a team which ones are important to filter our data -->
<!-- See data_cleaning_workflows repository (https://github.com/AtlasOfLivingAustralia/data_cleaning_workflows) -->

```{r}

```

### Which data variables do we want from galah?

<!-- AB to check with PB which columns we need  -->
Higher taxonomy e.g. family, class, genus
State information (NSW, NT, TAS, WA, SA, QLD, ACT, VIC)

```{r}
?galah_select
```

### Submit query to ALA

```{r}
Mygalomorphae_occurrences <- 
  galah_call() |>                               
  galah_identify("Mygalomorphae") |>   
  #galah_filter(identificationIncorrect == FALSE) |> # This is where we want to add in assertion filters
  galah_select(group = c("assertions")) |> # This is where we want to add in which columns we want
  atlas_occurrences() 
  #atlas_counts()

write_parquet(Mygalomorphae_occurrences, "output/mygalomorphae_wassertions.parquet")

Mygalomorphae_occurrences <- example_bg_job_results[["Mygalomorphae_occurrences"]]
names(Mygalomorphae_occurrences)

Mygalomorphae_occurrences |> pull(identificationIncorrect) |> tabyl()
```

### Save downlaoded data

Save the downloaded data as a `.parquet`

```{r}
write_parquet(Mygalomorphae_occurrences, paste0("data/galah/Mygalomorphae_", Sys.Date(), "_ALA.paraquet"))
```





